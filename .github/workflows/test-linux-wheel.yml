name: Test Linux Wheel

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
      distribution:
        required: false
        type: string
        default: 'ubuntu'
      ld-preload:
        required: false
        type: string
        default: ''
      timeout-minutes:
        required: false
        type: number
        default: 15
      pytest-markers:
        required: false
        type: string
        default: "-m 'not integration_test' -m 'not stress_test'"
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to test'
        required: true
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'
        default: '3.12'
      distribution:
        description: 'Linux distribution'
        required: true
        type: choice
        options:
          - 'ubuntu'
          - 'debian'
          - 'arch'
          - 'fedora'
          - 'opensuse'
        default: 'ubuntu'
      ld-preload:
        description: 'LD_PRELOAD value (for ASAN: LD_PRELOAD=$(gcc -print-file-name=libasan.so))'
        required: false
        type: string
        default: ''
      timeout-minutes:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 15
      pytest-markers:
        description: 'Pytest markers (e.g., -m stress_test)'
        required: false
        type: string
        default: "-m 'not integration_test' -m 'not stress_test'"

jobs:
  test-wheels-linux:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    container:
      image: ${{ 
        inputs.distribution == 'ubuntu' && 'ubuntu:latest' ||
        inputs.distribution == 'debian' && 'debian:latest' ||
        inputs.distribution == 'arch' && 'archlinux:latest' ||
        inputs.distribution == 'fedora' && 'fedora:latest' ||
        inputs.distribution == 'opensuse' && 'opensuse/leap:latest' ||
        'ubuntu:latest'
      }}
    env:
      REQUIREMENTS_FILE: ${{ inputs.python-version == '3.9' && 'requirements.3.9.txt' || 'requirements.txt' }}
    steps:
      - name: Install system dependencies
        run: |
          if [ "${{ inputs.distribution }}" = "ubuntu" ] || [ "${{ inputs.distribution }}" = "debian" ]; then
            apt-get update
            apt-get install -y python${{ inputs.python-version }} python3-pip git curl
          elif [ "${{ inputs.distribution }}" = "arch" ]; then
            pacman -Syu --noconfirm python python-pip git curl
          elif [ "${{ inputs.distribution }}" = "fedora" ]; then
            dnf install -y python${{ inputs.python-version }} python3-pip git curl
          elif [ "${{ inputs.distribution }}" = "opensuse" ]; then
            zypper refresh
            zypper install -y python3 python3-pip git curl
          fi
      
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ inputs.python-version }}
        if: ${{ inputs.distribution == 'ubuntu' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheels-linux-${{ inputs.python-version }}
          path: ./wheels/
      
      - name: Install wheel and dependencies
        run: |
          pip install pytest
          pip install -r $REQUIREMENTS_FILE
          pip install ./wheels/*.whl
      
      - name: Run tests
        run: |
          ${{ inputs.ld-preload }} python -m pytest ${{ inputs.pytest-markers }} -c pytest.ini --capture=no -vv
