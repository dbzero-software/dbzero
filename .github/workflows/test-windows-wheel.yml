name: Test Windows Wheel

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to test'
        required: true
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'
        default: '3.12'

jobs:
  build-wheel:
    if: github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/build-windows-wheel.yml
    with:
      python-version: ${{ inputs.python-version }}
      python-tag: ${{ inputs.python-version == '3.9' && '39' || inputs.python-version == '3.10' && '310' || inputs.python-version == '3.11' && '311' || inputs.python-version == '3.12' && '312' || inputs.python-version == '3.13' && '313' || '314' }}
      architecture: "AMD64"

  test-windows:
    runs-on: windows-latest
    needs: [build-wheel]
    if: always() && (needs.build-wheel.result == 'success' || needs.build-wheel.result == 'skipped')
    env:
      REQUIREMENTS_FILE: ${{ inputs.python-version == '3.9' && 'requirements.3.9.txt' || 'requirements.txt' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheels-windows-${{ inputs.python-version }}
          path: ./wheels/
      
      - name: Install wheel and dependencies
        run: |
          pip install pytest
          pip install -r $env:REQUIREMENTS_FILE
          Get-ChildItem -Path "./wheels/*.whl" | ForEach-Object { pip install $_.FullName }
        shell: powershell
      
      - name: Run tests
        run: |
          python -m pytest -m 'not integration_test' -m 'not stress_test' -c pytest.ini --capture=no -vv
