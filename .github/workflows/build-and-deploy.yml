name: Build and Deploy Packages
on:
  push:
    tags:
      - 'v[0-9]*'
      - feature/ci_test
  workflow_dispatch:

jobs:
  wheels-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.9"
            python-tag: "39"
            architecture: "AMD64"
          - python-version: "3.10"
            python-tag: "310"
            architecture: "AMD64"
          - python-version: "3.11"
            python-tag: "311"
            architecture: "AMD64"
          - python-version: "3.12"
            python-tag: "312"
            architecture: "AMD64"
          - python-version: "3.13"
            python-tag: "313"
            architecture: "AMD64"
          - python-version: "3.14"
            python-tag: "314"
            architecture: "AMD64"
    uses: ./.github/workflows/build-windows-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}
      python-tag: ${{ matrix.python-tag }}
      architecture: ${{ matrix.architecture }}

  wheels-linux:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    uses: ./.github/workflows/build-linux-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}

  wheels-macos:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    uses: ./.github/workflows/build-mac-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}

  test-wheels-windows:
    needs: wheels-windows
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.9"
            python-tag: "39"
            architecture: "AMD64"
          - python-version: "3.10"
            python-tag: "310"
            architecture: "AMD64"
          - python-version: "3.11"
            python-tag: "311"
            architecture: "AMD64"
          - python-version: "3.12"
            python-tag: "312"
            architecture: "AMD64"
          - python-version: "3.13"
            python-tag: "313"
            architecture: "AMD64"
          - python-version: "3.14"
            python-tag: "314"
            architecture: "AMD64"
    uses: ./.github/workflows/test-windows-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}

  test-wheels-linux:
    needs: wheels-linux
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    uses: ./.github/workflows/test-linux-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}

  test-wheels-macos:
    needs: wheels-macos
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    uses: ./.github/workflows/test-mac-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}

  stress-test-windows:
    needs: wheels-windows
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.9"
            python-tag: "39"
            architecture: "AMD64"
          - python-version: "3.10"
            python-tag: "310"
            architecture: "AMD64"
          - python-version: "3.11"
            python-tag: "311"
            architecture: "AMD64"
          - python-version: "3.12"
            python-tag: "312"
            architecture: "AMD64"
          - python-version: "3.13"
            python-tag: "313"
            architecture: "AMD64"
          - python-version: "3.14"
            python-tag: "314"
            architecture: "AMD64"
    uses: ./.github/workflows/test-windows-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}
      pytest-markers: "-m 'stress_test'"
      timeout-minutes: 60

  stress-test-linux:
    needs: wheels-linux
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    uses: ./.github/workflows/test-linux-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}
      pytest-markers: "-m 'stress_test'"
      timeout-minutes: 60

  stress-test-macos:
    needs: wheels-macos
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
    uses: ./.github/workflows/test-mac-wheel.yml
    with:
      python-version: ${{ matrix.python-version }}
      pytest-markers: "-m 'stress_test'"
      timeout-minutes: 60

  build-and-test-cpp:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', inputs.python-version)) || fromJSON('["3.9", "3.10", "3.11", "3.12", "3.13"]') }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build
          pip install meson ninja
      
      - name: Generate meson files
        run: |
          python3 scripts/generate_meson.py ./src/dbzero/ core
          python3 scripts/generate_meson_tests.py tests/
          python3 scripts/generate_meson_dbzero.py dbzero/
      
      - name: Configure build with tests enabled
        run: |
          meson setup --buildtype=release -Dbuild_tests=true build/release
      
      - name: Build project
        run: |
          cd build/release
          ninja
      
      - name: Run C++ tests
        run: |
          cd build/release
          meson test --verbose --print-errorlogs

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate meson files
        run: |
          python scripts/generate_meson.py ./src/dbzero/ core
          python scripts/generate_meson_tests.py tests/
          python scripts/generate_meson_dbzero.py dbzero/
      
      - name: Configure git
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI Builder"
          rm -f .gitignore
          git add . && git commit -m "Update meson files for build"  
      - run: python -m pip install build meson
      - run: python -m build --sdist
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
  
  deploy-to-pypi:
    name: Deploy to PyPI (Manual)
    runs-on: ubuntu-latest
    needs: [sdist, test-wheels-linux, test-wheels-windows, test-wheels-macos, stress-test-linux, stress-test-windows, stress-test-macos, build-and-test-cpp]
    environment: pypi-deployment
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
      
      - name: Flatten artifact structure
        run: |
          mkdir -p ./upload/
          find ./dist/ -name "*.whl" -exec cp {} ./upload/ \;
          find ./dist/ -name "*.tar.gz" -exec cp {} ./upload/ \;
          ls -la ./upload/
      
      - name: Install push tools
        run: |
          python -m pip install --upgrade pip
          pip install twine


      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload upload/*